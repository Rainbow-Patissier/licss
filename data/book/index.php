<?php
include_once('../link.php');
$title="エラーが発生";
$isbn=0;
if(isset($_GET['isbn'])){
	$isbn=(int)$_GET['isbn'];
	if($isbn!==0){
		$data=file_get_contents('https://api.openbd.jp/v1/get?isbn='.$isbn.'&pretty');
		$data=mb_convert_encoding($data, 'UTF8', 'ASCII,JIS,UTF-8,EUC-JP,SJIS-WIN');
		$data=json_decode($data,true);
		if(isset($data[0])){
			$book_name='';
			$book_name_ruby='';
			$book_name_sub='';
			$book_series='';
			$publish_company='';
			$publish_date='';
			$price='';
			$introduction="";
			if(isset($data[0]['onix']['DescriptiveDetail'])){
				$DescriptiveDetail=$data[0]['onix']['DescriptiveDetail'];
				if(isset($DescriptiveDetail['TitleDetail'])){
					if(isset($DescriptiveDetail['TitleDetail']['TitleElement'])){
						if(isset($DescriptiveDetail['TitleDetail']['TitleElement']['TitleText'])){
							//書名
							if(isset($DescriptiveDetail['TitleDetail']['TitleElement']['TitleText']['content'])){
								$book_name=$DescriptiveDetail['TitleDetail']['TitleElement']['TitleText']['content'];
							}else{
								$book_name="";
							}
							//ふりがな
							if(isset($DescriptiveDetail['TitleDetail']['TitleElement']['TitleText']['collationkey'])){
								$book_name_ruby=$DescriptiveDetail['TitleDetail']['TitleElement']['TitleText']['collationkey'];
							}else{
								$book_name_ruby='';
							}
						}
						//副書名
						if(isset($DescriptiveDetail['TitleDetail']['TitleElement']['Subtitle'])){
							$book_name_sub=$DescriptiveDetail['TitleDetail']['TitleElement']['Subtitle']['content'];
						}else{
							$book_name_sub='';
						}
					}
				}
				//シリーズ
				if(isset($DescriptiveDetail['Collection'])){
					if(isset($DescriptiveDetail['Collection']['TitleDetail'])){
						if(isset($DescriptiveDetail['Collection']['TitleDetail']['TitleElement'])){
							$book_series=$DescriptiveDetail['Collection']['TitleDetail']['TitleElement'][0]['TitleText']['content'];
						}
					}
				}
				//著者
				$person_name=array();
				$person_note=array();
				$person_name_ruby=array();
				if(isset($DescriptiveDetail['Contributor'])){
					foreach($DescriptiveDetail['Contributor'] as $key=>$row){
						if(isset($row['PersonName']['content'])){
							$person_name[$key]=$row['PersonName']['content'];
						}else{
							$person_name[$key]='';
						}
						if(isset($row['PersonName']['collationkey'])){
							$person_name_ruby[$key]=$row['PersonName']['collationkey'];
						}else{
							$person_name_ruby[$key]='';
						}
						if(isset($row['BiographicalNote'])){
							$person_note[$key]=$row['BiographicalNote'];
						}else{
							$person_note[$key]='';
						}
					}
				}
				//サイズ
				if(isset($DescriptiveDetail['Measure'])){
					$page_size="";
					foreach($DescriptiveDetail['Measure'] as $row){
						if($row['MeasureType']==='01'){
							$page_size.=$row['Measurement'].$row['MeasureUnitCode'];
						}elseif($row['MeasureType']==='02'){
							$page_size.='×'.$row['Measurement'].$row['MeasureUnitCode'];
						}elseif($row['MeasureType']==='03'){
							$page_size.='×'.$row['Measurement'].$row['MeasureUnitCode'];
						}
					}
				}
				//ページ数
				if(isset($DescriptiveDetail['Extent'])){
					if(isset($DescriptiveDetail['Extent'][0]['ExtentValue'])){
						$page_number=$DescriptiveDetail['Extent'][0]['ExtentValue'];
					}else{
						$page_number='';
					}
				}
			}
			if(isset($data[0]['onix']['PublishingDetail'])){
				$PublishingDetail=$data[0]['onix']['PublishingDetail'];
				//出版社
				if(isset($PublishingDetail['Imprint'])){
					if(isset($PublishingDetail['Imprint']['ImprintName'])){
						$publish_company=$PublishingDetail['Imprint']['ImprintName'];
					}else{
						$publish_company='';
					}
				}
				if(isset($PublishingDetail['PublishingDate'])){
					//出版日
					if(isset($PublishingDetail['PublishingDate'][0]['Date'])){
						$publish_date=$PublishingDetail['PublishingDate'][0]['Date'];
					}else{
						$publish_date='';
					}
				}

			}
			if(isset($data[0]['onix']['CollateralDetail'])){
				$CollateralDetail=$data[0]['onix']['CollateralDetail'];
				//内容紹介
				if(isset($CollateralDetail['TextContent'])){
					foreach($CollateralDetail['TextContent'] as $val){
						$introduction.=$val."\n";
					}
				}
				if(isset($CollateralDetail['SupportingResource'])){
					if(isset($CollateralDetail['SupportingRosource'][0]['ResourceVersion'])){
						if(isset($CollateralDetail['SupportingRosource'][0]['ResourceVersion'][0]['ResourceLink'])){
							//書影
							if(isset($CollateralDetail['SupportingResource'][0]['ResourceVersion'][0]['ResourceLink'])){
								$image=$CollateralDetail['SupportingResource'][0]['ResourceVersion'][0]['ResourceLink'];
							}else{
								$image=$url.'img/book_noimage.jpg';
							}
						}
					}
				}

			}
			if(isset($data[0]['onix']['ProductSupply'])){
				$ProductSupply=$data[0]['onix']['ProductSupply'];
				//金額
				if(isset($ProductSupply['SupplyDetail'])){
					if(isset($ProductSupply['SupplyDetail']['Price'])){
						if(isset($ProductSupply['SupplyDetail']['Price'][0]['PriceAmount'])){
							$price=$ProductSupply['SupplyDetail']['Price'][0]['PriceAmount'];
						}else{
							$price='';
						}
					}
				}
			}
		}
		$title=$book_name;
	}
}
include_once('../header.php');
?>
<nav id="bread_crumb">
	<ul id="bread_crumb_list">
		<li>
			<a href="<?=$request_url;?>">
				<?=$title;?>
			</a>
		</li>
	</ul>
</nav>
<section id="main_content"><?php
	if(isset($data[0])){
		?>
	<table>
		<caption>
			書誌情報
		</caption>
		<tbody>
			<tr>
				<th>
					ISBN
				</th>
				<td>
					<?=$isbn;?>
				</td>
			</tr>
			<tr>
				<th>
					シリーズ名
				</th>
				<td>
					<?=$book_series;?>
				</td>
			</tr>
			<tr>
				<th rowspan="2">
					書名
				</th>
				<td>
					<?=$book_name_ruby;?>
				</td>
			</tr>
			<tr>
				<td>
					<?=$book_name;?>
				</td>
			</tr>
			<tr>
				<th>
					副書名
				</th>
				<td>
					<?=$book_name_sub;?>
				</td>
			</tr><?php
		foreach($person_name as $key=>$val){
			?>
			<tr>
				<th rowspan="3">
					著作者<?=$key+1;?>
				</th>
				<td>
					<?=$person_name_ruby[$key];?>
				</td>
			</tr>
			<tr>
				<td>
					<?=$person_name[$key];?>
				</td>
			</tr>
			<tr>
				<td>
					<?=$person_note[$key];?>
				</td>
			</tr><?php
		}
		?>
			<tr>
				<th>
					出版社
				</th>
				<td>
					<?=$publish_company;?>
				</td>
			</tr>
			<tr>
				<th>
					出版日
				</th>
				<td>
					<?=$publish_date;?>
				</td>
			</tr>
			<tr>
				<th>
					サイズ
				</th>
				<td>
					<?=$page_size;?>
				</td>
			</tr>
			<tr>
				<th>
					ページ数
				</th>
				<td>
					<?=$page_number;?>頁
				</td>
			</tr>
			<tr>
				<th>
					金額
				</th>
				<td>
					<?=$price;?>円
				</td>
			</tr>
			<tr>
				<th>
					内容紹介
				</th>
				<td>
					<?=ALL::h($introduction);?>
				</td>
			</tr>
		</tbody>
	</table><?php
	}else{
	?>
	<div>
		<h2>
			エラーが発生
		</h2>
		<p>
			書誌情報を取得できませんでした。
		</p>
		<p>
			恐れ入りますが，もう一度始めからやり直してください。
		</p>
	</div><?php	
	}
	?>
</section><?php
include_once('../footer.php');
?>